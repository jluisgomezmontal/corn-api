<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bob's Corn Stand</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* A simple animation for the corn emoji on success */
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .corn-pop {
            animation: pop 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-amber-50 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            // State variables
            const [message, setMessage] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [cooldown, setCooldown] = useState(0);
            const [isError, setIsError] = useState(false);

            // Effect for the cooldown timer
            useEffect(() => {
                if (cooldown > 0) {
                    const timer = setTimeout(() => {
                        setCooldown(cooldown - 1);
                    }, 1000);
                    // Cleanup the timer if the component unmounts
                    return () => clearTimeout(timer);
                }
            }, [cooldown]);

            // Function to handle the button click
            const handleBuyCorn = async () => {
                setIsLoading(true);
                setMessage('');
                setIsError(false);

                try {
                    // Make the POST request to the backend
                    const response = await fetch('http://localhost:3001/api/buy-corn', {
                        method: 'POST',
                    });

                    const responseText = await response.text();

                    if (response.ok) { // Status 200
                        setMessage(responseText);
                        setCooldown(60); // Start 60-second cooldown
                    } else if (response.status === 429) { // Status 429
                        setMessage(responseText);
                        setIsError(true);
                        // Extract time from server message to sync cooldown
                        const timeLeft = parseInt(responseText.match(/\d+/)[0] || 60);
                        setCooldown(timeLeft);
                    } else {
                        throw new Error('An unexpected error occurred.');
                    }
                } catch (error) {
                    console.error("Failed to buy corn:", error);
                    setMessage('Could not connect to Bob\'s server. Is it running?');
                    setIsError(true);
                } finally {
                    setIsLoading(false);
                }
            };

            const buttonDisabled = isLoading || cooldown > 0;

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 text-center font-sans">
                    <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
                        <header className="mb-6">
                            <h1 className="text-5xl font-bold text-amber-900">Bob's Corn Stand</h1>
                            <p className="text-gray-500 mt-2">The freshest corn, sold fairly.</p>
                        </header>

                        <main>
                            <div className="mb-6">
                                <button
                                    onClick={handleBuyCorn}
                                    disabled={buttonDisabled}
                                    className={`
                                        w-full px-8 py-4 text-2xl font-bold text-white rounded-lg
                                        transition-all duration-300 ease-in-out transform
                                        focus:outline-none focus:ring-4 focus:ring-amber-300
                                        ${buttonDisabled
                                            ? 'bg-gray-400 cursor-not-allowed'
                                            : 'bg-amber-500 hover:bg-amber-600 active:scale-95'
                                        }
                                    `}
                                >
                                    {isLoading
                                        ? 'Harvesting...'
                                        : cooldown > 0
                                            ? `Next corn in ${cooldown}s`
                                            : 'Buy 1 Corn ðŸŒ½'
                                    }
                                </button>
                            </div>

                            {message && (
                                <div className={`mt-4 p-4 rounded-lg text-xl transition-opacity duration-500 ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                                    {message === 'ðŸŒ½' ? (
                                      <span className="inline-block text-6xl corn-pop">{message}</span>
                                    ) : (
                                      <p>{message}</p>
                                    )}
                                </div>
                            )}
                        </main>
                    </div>
                     <footer className="text-center mt-8 text-gray-500">
                        <p>One corn per customer per minute. That's Bob's promise!</p>
                    </footer>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
